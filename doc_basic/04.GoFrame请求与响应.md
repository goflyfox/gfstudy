# 第四章 GoFrame的请求与响应

## 4.1 请求Request对象

请求输入依靠 `ghttp.Request` 对象实现，`ghttp.Request`继承了底层的`http.Request`对象。`ghttp.Request`包含一个与当前请求对应的返回输出对象`Response`，用于数据的返回处理。

可以看到`Request`对象的参数获取方法非常丰富，可以分为以下几类：

1. `Get*`: 常用方法，简化参数获取，`GetRequest*`的别名。
2. `GetQuery*`: 获取`GET`方式传递过来的参数，包括`Query String`及`Body`参数解析。
3. `GetForm*`: 获取表单方式传递过来的参数，表单方式提交的参数`Content-Type`往往为`application/x-www-form-urlencoded`, `application/form-data`, `multipart/form-data`, `multipart/mixed`等等。
4. `GetRequest*`: 获取客户端提交的参数，不区分提交方式。
5. `Get*Struct`: 将指定类型的请求参数绑定到指定的`struct`对象上，注意给定的参数为对象指针。绝大部分场景中往往使用`Parse`方法将请求数据转换为请求对象，具体详见后续章节。
6. `GetBody/GetBodyString`: 获取客户端提交的原始数据，该数据是客户端写入到`body`中的原始数据，与`HTTP Method`无关，例如客户端提交`JSON/XML`数据格式时可以通过该方法获取原始的提交数据。
7. `GetJson`: 自动将原始请求信息解析为`gjson.Json`对象指针返回。
8. `Exit*`: 用于请求流程退出控制；

## 4.2 响应Response

`ghttp.Response`对象实现了标准库的`http.ResponseWriter`接口。数据输出使用`Write*`相关方法实现，并且数据输出采用了`Buffer`机制，因此数据的处理效率比较高。任何时候可以通过`OutputBuffer`方法输出缓冲区数据到客户端，并清空缓冲区数据。

简要说明:

1. `Write*`方法用于数据的输出，可为任意的数据格式，内部通过断言对参数做自动分析。
2. `Write*Exit`方法用于数据输出后退出当前服务方法，可用于替代`return`返回方法。
3. `WriteJson*`/`WriteXml`方法用于特定数据格式的输出，这是为开发者提供的简便方法。
4. `WriteTpl*`方法用于模板输出，解析并输出模板文件，也可以直接解析并输出给定的模板内容。
5. `ParseTpl*`方法用于模板解析，解析模板文件或者模板内容，返回解析后的内容。

## 4.3 教程示例

```go
package main

import (
	"github.com/gogf/gf/v2/container/gtype"
	"github.com/gogf/gf/v2/frame/g"
	"github.com/gogf/gf/v2/net/ghttp"
)

func main() {
	s := g.Server()
	// 常规注册
	// hello方法，post调用
	s.BindHandler("POST:/hello", func(r *ghttp.Request) {
		r.Response.Writeln("url" + r.Router.Uri)
	})
	// 所有方法，url包含name参数
	s.BindHandler("/:name", func(r *ghttp.Request) {
		// 获取URL name参数
		r.Response.Writeln("name:" + r.Get("name").String())
		r.Response.Writeln("url" + r.Router.Uri)
	})
	// 所有方法，url包含name参数
	s.BindHandler("/:name/update", func(r *ghttp.Request) {
		r.Response.Writeln("name:" + r.Get("name").String())
		r.Response.Writeln("url" + r.Router.Uri)
	})
	// 所有方法，url包含name和action参数
	s.BindHandler("/:name/:action", func(r *ghttp.Request) {
		r.Response.Writeln("name:" + r.Get("name").String())
		r.Response.Writeln("action:" + r.Get("action").String())
		r.Response.Writeln("url" + r.Router.Uri)
	})
	// 所有方法，url包含field属性
	s.BindHandler("/user/list/{field}.html", func(r *ghttp.Request) {
		// 获取URL field属性
		r.Response.Writeln("field:" + r.Get("field").String())
		r.Response.Writeln("url" + r.Router.Uri)
	})

	// 方法注册
	s.BindHandler("/total", Total)

	// 对象注册
	c := new(Controller)
	s.BindObject("POST:/object", c)

	// 分组注册及中间件
	group := s.Group("/api")
	group.Middleware(MiddlewareTest)
	group.ALL("/all", func(r *ghttp.Request) {
		r.Response.Writeln("all")
	})
	group.GET("/get", func(r *ghttp.Request) {
		r.Response.Writeln("get")
	})
	group.POST("/post", func(r *ghttp.Request) {
		r.Response.Writeln("post")
	})

	// request and response
	s.BindHandler("POST:/test", func(r *ghttp.Request) {
		r.Response.WriteJson(g.Map{
			"name": r.Get("name").String(),
			"age":  r.Get("age").Int(),
			"sex":  r.Header.Get("sex"),
		})
	})

	s.SetPort(8199)
	s.Run()
}

var (
	total = gtype.NewInt()
)

func Total(r *ghttp.Request) {
	r.Response.Write("total:", total.Add(1))
}

// 对象注册
type Controller struct{}

func (c *Controller) Index(r *ghttp.Request) {
	r.Response.Write("index")
}

func (c *Controller) Show(r *ghttp.Request) {
	r.Response.Write("show")
}

// 中间件
func MiddlewareTest(r *ghttp.Request) {
	// 前置逻辑
	r.Response.Writeln("###start")
	r.Middleware.Next()
	// 后置逻辑
	r.Response.Writeln("###end")
}
```

访问结果：

```go
### 常规注册
POST http://localhost:8199/hello

###
GET http://localhost:8199/abc

###
GET http://localhost:8199/a/add

###
GET http://localhost:8199/a/update

###
GET http://localhost:8199/user/list/11.html

### 方法注册
GET http://localhost:8199/total

### 对象注册，默认访问index
POST http://localhost:8199/object/

### 对象注册，直接访问Index
POST http://localhost:8199/object/index

### 对象注册，访问show方法
POST http://localhost:8199/object/show

### 分组，默认访问index
PUT http://localhost:8199/api/all

### 对象注册，直接访问Index
GET http://localhost:8199/api/get

### 对象注册，访问show方法
POST http://localhost:8199/api/post

### request and response
POST http://localhost:8199/test
sex:man

name=liubang&age=18

###
```

